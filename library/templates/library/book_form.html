{% load my_tags %}
{% load static %}
{% load spacify %} 
{%block content %}
<style>



#author-overlay {
position: fixed;
display:none;
width: 600px;
height: 400px;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: white;
z-index: 2;

margin: auto;

border-style: solid;
border-color: #b30000;
padding:25px;
border-radius: 15px;
}


#publisher-overlay {
position: fixed;
display:none;
width: 600px;
height: 400px;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: white;
z-index: 2;

margin: auto;

border-style: solid;
border-color: #b30000;
padding:25px;
border-radius: 15px;
}


#warning-item-overlay {
position: fixed;
display:none;
width: 350px;
height: 200px;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: white;
z-index: 2;

margin: auto;

border-style: solid;
border-color: #b30000;
padding:25px;
border-radius: 15px;
}




.book-form, td, th, #book-overlay{
  border: 10px solid black;
  border-color:white;

}

.tr{

  width:400px
}

.tr{

  padding-left:15px;
}

.ti{
  padding-left:0;

{% comment %} }
input{
  width:100%;
}
 {% endcomment %}



</style>







{%if error%}

<div class="warning-display m-0" ><p>{{error}}</p></div>

{%endif%}

<form method="post" id="bookForm">{% csrf_token %}



<div id="warning-item-overlay" class="overlay pt-4">

<p  style="  text-align: justify;text-justify: inter-word;">Editar este campo pode comprometer a integridade do sistema.</p>
<p style="text-align:center;" >Deseja Continuar?</p>


<div style="display: flex; justify-content: center;">
      <a class="btn text-white mt-2 ml-3" style="width:100px;background: #b30000;" id="warning-cancel" >Cancelar</a>

      <a class="btn text-white mt-2 ml-3" style="background: #b30000;" id="warning-confirm" >Confirmar</a>
</div>


</div>







<div id="publisher-overlay" class="overlay pt-4">
  
  <a class="b-r btn m-0 p-0"  id="btn-publisher-cancel" style="position:relative; right:-3%; top:-20px; float: right; font-size: 33px" ><i style="color:#b30000" class="far fa-times-circle"></i> </a>
  <h1 class="title">Editora</h1>
  <div id="publisher-overlay-inside">
   
   
   
   
   
   
   
   
   
{% comment %}    
   
   '<div class="form-group row">
      <label for="" id=""class="pr-0 mr-0 col-sm-3 col-form-label">Nome Completo: </label>
      <div class="col-sm-9 ml-0">
        <input type="text" name="name" class="publisher-form form-control" id="" placeholder="">
          
      </div>
    </div>  
     <div class="form-group row">
      <label for="" id=""class="pr-0 mr-0 col-sm-3 col-form-label">Data de Nascimento: </label>
      <div class="col-sm-9 ml-0">
        <input type="text" name="birthyear" class="publisher-form form-control" id="" placeholder="">
          
      </div>
    </div> 
     <div class="form-group row">
      <label for="" id=""class="pr-0 mr-0 col-sm-3 col-form-label">Data de Óbito: </label>
      <div class="col-sm-9 ml-0">
        <input type="text" name="deathyear"class="publisher-form form-control" id="" placeholder="">
          
      </div>
    </div> 
  <div id="publisher-overlay-buttons"style="display: flex; justify-content: center; margin-top:25px">
    <a  class="btn  btn-normal ml-1" id="btn-publisher-cancel" style="width:132px" >Cancelar</a>
    <a  class="btn  btn-normal ml-1" id="btn-publisher-manual-confirm" style="width:132px" >Confirmar</a>
  </div>
</div>'
 {% endcomment %}






    <div class="form-group row">
      <label for="" id="dropdown-publishers-label"class="pr-0 mr-0 col-sm-3 col-form-label">Pesquisar Editora: </label>
      <div class="col-sm-9 ml-0">

          <div style="display: flex;">
            <input type="text" class="form-control" id="inputPublisher" placeholder="">
            
              <div class=""style=" background-color:#b30000; margin: auto; width: 40px; height: 38px; vertical-align: middle;text-align: center;display: table-cell;">

                <a class="btn-normal" id="btn-publisher-add" ><i style="font-size: 20px;padding-top: 9px;" class="fas fa-search"></i></a>
              </div>
            
            
          </div>
      </div>
    </div>
  

 

  <div class="form-group row">
    <label for="" id="dropdown-publishers-label"class="ml-0 col-sm-3 col-form-label"></label>
    <div id="dropdown-publishers" class="col-sm-9 ml-0">
      
    </div>
  </div>
  <div id="publisher-overlay-buttons"style="display: flex; justify-content: center; margin-top:25px">
  </div>

</div>



</div>


<div id="author-overlay" class="overlay pt-4">
  <a class="b-r btn m-0 p-0"  id="btn-book-cancel" style="position:relative; right:-3%; top:-20px; float: right; font-size: 33px" ><i style="color:#b30000" class="far fa-times-circle"></i> </a>
  <h1 class="title">Autor</h1>
  <div id="author-overlay-inside">
   
   
   
   
   
   
   
   
   
{% comment %}    
   
   '<div class="form-group row">
      <label for="" id=""class="pr-0 mr-0 col-sm-3 col-form-label">Nome Completo: </label>
      <div class="col-sm-9 ml-0">
        <input type="text" name="name" class="author-form form-control" id="" placeholder="">
          
      </div>
    </div>  
     <div class="form-group row">
      <label for="" id=""class="pr-0 mr-0 col-sm-3 col-form-label">Data de Nascimento: </label>
      <div class="col-sm-9 ml-0">
        <input type="text" name="birthyear" class="author-form form-control" id="" placeholder="">
          
      </div>
    </div> 
     <div class="form-group row">
      <label for="" id=""class="pr-0 mr-0 col-sm-3 col-form-label">Data de Óbito: </label>
      <div class="col-sm-9 ml-0">
        <input type="text" name="deathyear"class="author-form form-control" id="" placeholder="">
          
      </div>
    </div> 
  <div id="author-overlay-buttons"style="display: flex; justify-content: center; margin-top:25px">
    <a  class="btn  btn-normal ml-1" id="btn-book-cancel" style="width:132px" >Cancelar</a>
    <a  class="btn  btn-normal ml-1" id="btn-book-manual-confirm" style="width:132px" >Confirmar</a>
  </div>
</div>'
 {% endcomment %}






    <div class="form-group row">
      <label for="" id="dropdown-authors-label"class="pr-0 mr-0 col-sm-3 col-form-label">Pesquisar Autor: </label>
      <div class="col-sm-9 ml-0">

          <div style="display: flex;">
            <input type="text" class="form-control" id="inputAuthor" placeholder="">
            
              <div class=""style=" background-color:#b30000; margin: auto; width: 40px; height: 38px; vertical-align: middle;text-align: center;display: table-cell;">

                <a class="btn-normal" id="btn-book-add" ><i style="font-size: 20px;padding-top: 9px;" class="fas fa-search"></i></a>
              </div>
            
            
          </div>
      </div>
    </div>
  

 

  <div class="form-group row">
    <label for="" id="dropdown-authors-label"class="ml-0 col-sm-3 col-form-label"></label>
    <div id="dropdown-authors" class="col-sm-9 ml-0">
      
    </div>
  </div>
  <div id="author-overlay-buttons"style="display: flex; justify-content: center; margin-top:25px">
  </div>

</div>



</div>


<input type="radio" name="Radio" value="1" id="Radio1" style="display:none;">
<div class="container">


  <h1 class="title">Inserir Livro</h1>

    <div id="form-item-row" class="form-group form-row row">
      <label for="" class="col-sm-1 col-form-label">Iventário:</label>
      <div id="" class="col-sm-11">

        <div class="form-check form-check-inline col-md-1 ">
          <input class="form-check-input" type="radio" name="inputType" id="inputTypeRadio1" value="I" >
          <label class="form-check-label" for="inputTypeRadio1">
            Doada
          </label>
        </div>
        <div class="form-check form-check-inline col-md-1">
          <input class="form-check-input" type="radio" name="inputType" id="inputTypeRadio2" value="F">
          <label class="form-check-label" for="inputTypeRadio2">
            Comprado
          </label>
        </div>
              <div class="form-check form-check-inline col-md-1 ">
          <input style="display:none;" class="form-check-input" type="radio" name="inputType" id="inputTypeRadioHidden" value="-1" checked>
          
            
        </div>
      </div>
    </div>

    <div id="form-identifier-row" class="form-group row">
      <label for="" class="col-sm-1 col-form-label">Código:</label>
      <div class="col-sm-11">
        <input type="text" name="identifier" class="form-control" id="form-identifier" value="" placeholder="" readonly>
      </div>
    </div>

    <div id="form-title-row" class="form-group row">
      <label for="" class="col-sm-1 col-form-label">Titulo:</label>
      <div class="col-sm-11">
        <input type="text" name="title" class="form-control" id="form-title" value="{{title}}" placeholder="">
      </div>
    </div>

    <div class="form-group row">
      <label for="" class="col-sm-1 col-form-label">Autores:</label>
      <div id="form-authors" class="col-sm-11">
        
        
          <input type="text" class="d-inline form-control" id="inputBook" placeholder="">
          {%for author in authors%}
            <div style="display: flex;" >
            <a href="#"class="b-r mr-2 btn-author-delete" style="padding-top: 5px;font-size: 20px;">
            <i class="far fa-trash-alt"></i></a>
            <input type="text" readonly class="d-inline form-control-plaintext"  value={{author|spacify}}>
            <input type="hidden" name="authors" value="{{author.pk}}"/></div>
          {%endfor%}
      {% comment %} <div style="display: flex;" >

          <a href="#"class="b-r mr-2 btn-author-delete" style="padding-top: 5px;font-size: 20px;"><i class="far fa-trash-alt"></i></a>
          <input type="text" readonly class="d-inline form-control-plaintext"  value='+selectedText+'>
          <input type="hidden" name="authors" value='+selected+'/>
      </div>
       {% endcomment %}


      </div>
    </div>


    <div class="form-group row">
      <label  for="" class="col-sm-1 col-form-label">Editora:</label>
      <div id="form-publishers" class="col-sm-11">
        <input type="text" class="form-control" id="inputPublisher1"autocomplete="off" value="{{publisher.name|spacify}}"placeholder="">
        <input type="hidden" id="hidden-publisher" name="publisher" value="{{publisher.pk}}"/>
      </div>
    </div>
    
    <div class="form-group row">
      <label for="" class="col-sm-1 col-form-label">Ano:</label>
      <div class="col-sm-11">
        <input type="text" class="form-control" name="year" id="" value="{{year}}" placeholder="">
      </div>
    </div>

    <div class="form-group row">
      <label for="" class="col-sm-1 col-form-label">Categoria:</label>
      <div id="categories-dropdown" class="form-group col-sm-4">
        <select id="category0" data-depth="0" class="form-control categories-drop ">
              <option value="-1">Selecione a Categoria</option>
              {%for category in categories%}
              <option value="{{category.pk}}">{{ category}}</option>
              {%endfor%}
        </select>
      </div>
{% comment %} 
          <div class="form-group col-sm-4">
        <select id="category1" class="form-control">
             
        </select>
      </div>
        
          <div class="form-group col-sm-3">
        <select id="category2" class="form-control">
          
        </select>
        
      </div> {% endcomment %}
        
      </div>
    </div>






















<input type="hidden" class="bookForm" id="id_category" name="category" value="">
<a id="submit" class="btn btn-normal">Confirmar</a>


</form>

<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

<script src="{% static 'library/insertPublisher.js' %}"></script>
<script src="{% static 'library/insertAuthor.js' %}"></script>
<script>

var warning_flag=false;


$(document).on('click','#submit', function(e){
  title=$('#form-title').val()
  $("div").remove(".warning-display");
  var type=$('input[name=inputType]:checked', '#form-item-row').val();

  if (type !== "-1"){

      if (title!==""){


        $("#bookForm").submit();

      }
      else{
        $('#form-title-row').prepend('<div class="warning-display form-control " ><p>Este campo é obrigatório</p></div>');

        

      }



  }
  else{

    $('#form-item-row').prepend('<div class="warning-display form-control m-0 " ><p>Este campo é obrigatório</p></div>');

  }

});



$(document).on('click','#warning-confirm', function(e){
  console.log("warning-confirm");
  
  

    $('#form-identifier').prop('readonly', false);
    $("#warning-item-overlay").css("display", "none");
    warning_flag=true;


  
  
  





});





$(document).on('click','#warning-cancel', function(e){

  $("#warning-item-overlay").css("display", "none");



});


$(document).on('click','#form-identifier', function(e){
  var type=$('input[name=inputType]:checked', '#form-item-row').val();


  if (type !== "-1" && warning_flag==false){
  $("#warning-item-overlay").css("display", "block");
  }



});

$(document).on('change','#form-identifier', function(e){
  console.log("change");
  $("div").remove(".warning-display");

	var type=$('input[name=inputType]:checked', '#form-item-row').val();
  var identifier=$('#form-identifier').val();

  
     $.ajax({                       
    url:"{% url 'ajax-check-identifier' %}",
                    
    data: {
        item:type,  
        identifier:identifier,   
    },
    success: function (data) {
        console.log(data)
        if(data === "-1"){
          console.log(" existe")
          $('#form-identifier-row').prepend('<div class="warning-display form-control " ><p>Este identificador já está a ser usado</p></div>');
          $('#form-identifier').val("")

          
        }
        else if(data ==="0"){
          console.log("não existe")

        }
    },
    
  });

});



$(document).on('change','input[type=radio][name=inputType]', function(e){
    warning_flag=false
    $('#form-identifier').prop('readonly', true);

  console.log("input radio")
	var type=$('input[name=inputType]:checked', '#form-item-row').val();
  console.log(type)
   $.ajax({                       // initialize an AJAX request
    url:"{% url 'ajax-check-item' %}",
                    // set the url of the request (= localhost:8000/hr/ajax/load-cities/)
    data: {
        item:type,      // add the country id to the GET parameters
    },
    success: function (data) {
        console.log(data)
        $('#form-identifier').val(data);
    },
    
  });



  

});


$(document).on('change','.categories-drop', function(e){




  






  var depth=parseInt($(this).attr("data-depth"));
  console.log(depth);

  var selects=$("#categories-dropdown").children("select");


  

  console.log(parseInt($(selects[selects.length-1]).attr("data-depth")));

  if (parseInt($(selects[selects.length-1]).attr("data-depth"))>depth){
      console.log("erro");
      $(selects).each(function() {
        if (parseInt($(this).attr("data-depth"))>depth){
          $(this).remove();

        }
        
    
      });

  }




  var categoryId = $(this).val();  // get the selected country ID from the HTML input

  if (categoryId !=="-1"){
    $("#id_category").val(categoryId);

      $.ajax({                       // initialize an AJAX request
        url:"{% url 'ajax-load-categories' %}",
                        // set the url of the request (= localhost:8000/hr/ajax/load-cities/)
        data: {
            'category': categoryId       // add the country id to the GET parameters
        },
        success: function (data) {
          ////console.log("sucesso")
          ////console.log(data)
            ////console.log(data.length)

          if(data.length!==0){

            var sel=$('<select>').appendTo('#categories-dropdown').addClass("form-control categories-drop").attr("data-depth",data[0].fields.depth);
            sel.append($("<option>").text("Selecione Subcategoria").attr('value',"-1"));    

            }
          
          $(data).each(function() {

              sel.append($("<option>").attr('value',this.pk).text(this.fields.name.replaceAll(" ", "\xa0")));
        
          });


          $("#teste").html(data);  // replace the contents of the city input with the data that came from the server
          $('#id_category').attr("value", $('#var').val());
          ////console.log($('#id_category').val());

          ////console.log($('.categories-drop'));
        }
      });

  }
  
});
  




 {% comment %} $(document).on('click', "#btn-publisher-cancel1", function(){
    //console.log("aqui!!");

    //console.log($("#publisher-overlay"));
    //restart();
    $("#publisher-overlay").css("display", "none");
  
  
  }); {% endcomment %}



//insert author ajax get


function ajaxGETauthor(dataToSend){


 $.ajax({
    type: 'GET',
          url: "{% url 'ajax-insert-author' %}",
          data:{ name:dataToSend},

    success: function(data){
      //console.log("data")

      if (data==-1){
        //console.log("nao encontrou")
        loadAuthorManual();

      }
      else{
            //console.log(data);

            $('#search-author').remove();
            var sel=$('<select>').appendTo('#dropdown-authors');
            
            var label=$('#dropdown-authors').parent();

            //console.log("label");
            label.children('label').text("Resultados:");

            $("label[for='select-author']").text("Resultados:");
            
            


            sel.attr('id', 'select-author');
            sel.addClass("form-control");

            $('#author-overlay-buttons').prepend('<a  class="btn  btn-normal ml-1" id="btn-author-manual" style="width:132px" >Manualmente</a>');
            $('#author-overlay-buttons').prepend('<a  class="btn  btn-normal ml-1" id="btn-book-confirm" style="width:132px" >Confirmar</a>');
            
            var dataJson1 = JSON.parse(data);
            //console.log(dataJson1)
            $(dataJson1).each(function() {

            //   {% comment %} Subtituir espaços {% endcomment %}
              sel.append($("<option>").attr('value',this.pk).text(this.name.replaceAll(" ", "\xa0")));
            });


      }

    }});



}


function ajaxPOSTauthor(dataToSend){

  $.ajax({
                  type: "POST",
                  url: "{% url 'ajax-insert-author' %}",
                  
                  data:{
                        form: dataToSend, // serializes the form's elements.
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                  success: function(data)
                  {
                      //console.log("Sucesso"); // show response from the php script.
                      var dataJson = JSON.parse(data);
  
                      //console.log(dataJson);                    
  
                      
                      var htmlString='<div style="display: flex;" ><a href="#"class="b-r mr-2 btn-author-delete" style="padding-top: 5px;font-size: 20px;"><i class="far fa-trash-alt"></i></a><input type="text" readonly class="d-inline form-control-plaintext"  value='+dataJson.name.replaceAll(" ", "\xa0")+'><input type="hidden" name="authors" value="'+dataJson.pk+'"/></div>';

                      
                      console.log(dataJson.pk)
                      $("#form-authors").append(htmlString);
                      restart();
  
                  }
                });
  
}


function ajaxGETpublisher(dataToSend){
$.ajax({
    type: 'GET',
          url: "{% url 'ajax-insert-publisher' %}",
          data:{ name:dataToSend},

    success: function(data){
      //console.log("data")

      if (data==-1){
        //console.log("nao encontrou")
        loadPublisherManual();

      }
      else{
            //console.log(data);

            $('#search-publisher').remove();
            var sel=$('<select>').appendTo('#dropdown-publishers');
            
            var label=$('#dropdown-publishers').parent();

            //console.log("label");
            label.children('label').text("Resultados:");

           
            
            


            sel.attr('id', 'select-publisher');
            sel.addClass("form-control");

            $('#publisher-overlay-buttons').prepend('<a  class="btn  btn-normal ml-1" id="btn-publisher-manual" style="width:132px" >Manualmente</a>');
            $('#publisher-overlay-buttons').prepend('<a  class="btn  btn-normal ml-1" id="btn-publisher-confirm" style="width:132px" >Confirmar</a>');
            
            
            $(data).each(function() {

            //   {% comment %} Subtituir espaços {% endcomment %}
              sel.append($("<option>").attr('value',this.pk).text(this.fields.name.replaceAll(" ", "\xa0")));
            });


      }

    }});





  
}


function ajaxPOSTpublisher(dataToSend){
  $.ajax({
                  type: "POST",
                  url: "{% url 'ajax-insert-publisher' %}",
                  
                  data:{
                        form: dataToSend, // serializes the form's elements.
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                  success: function(data)
                  {
                      //console.log("Sucesso"); // show response from the php script.
                      var dataJson = JSON.parse(data);
  
                      //console.log(dataJson);                    
  
                          clearPublisherInput();
                          var htmlString=('<input type="hidden" id="hidden-publisher" name="publisher" value="'+dataJson.pk+'"/></div>');
                          $("#inputPublisher1").val(dataJson.name);
    
  
                      //console.log(htmlString)
                      $("#form-publishers").append(htmlString);
                      restartPublisher();
  
                  }
                });

  
}




</script>

{% endblock content%}